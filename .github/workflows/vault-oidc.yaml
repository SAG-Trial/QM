name: Vault OIDC Login

on:
    workflow_dispatch:

env:
  hashiUrl: https://9sndck32-8200.inc1.devtunnels.ms
  roleName: gha-test-role
  audience: https://github.com/SAG-Trial

jobs:
    hello:
        runs-on: ubuntu-latest
        name: Says Hello World
        permissions: 
            contents: read
            id-token: write
        steps:
            - name: Say it
              run: echo "Hello World"

            - name: Troubleshooting
              run: |
                  curl -sSL -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL" | \
                  jq "{ jwt: .value, role: \"${{env.roleName}}\" }" > ./token.json
                      
                  echo 'GitHub Actions Token Claims'
                  cat ./token.json | jq -r '.jwt | split(".") | .[1] | @base64d' | jq
          
                  echo 'Vault Login Response'
                  curl -sSLf -X POST -H "Content-Type: application/json" -H "X-Vault-Namespace: admin" --data @token.json ${{env.hashiUrl}}/v1/auth/jwt/github_actions/login
          
                  # Remove the token file when we're done (if we don't fail)
                  rm ./token.json

            - name: Retreive Secrets
              id: retrieve-secrets
              uses: hashicorp/vault-action@v2
              with:
                method: jwt
                url: ${{ env.hashiUrl }}
                path: secret/data/apikeys
                role: ${{ env.roleName }}
                jwtGithubAudience: ${{env.audience}}
                secrets: secret/data/apikeys weatherApi | WEATHER_KEY

            - name: Check Weather API Key
              run: |
                echo $WEATHER_KEY  
              env: 
                WEATHER_KEY: ${{ steps.retrieve-secrets.outputs.WEATHER_KEY }}        