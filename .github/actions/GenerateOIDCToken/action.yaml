name: Generate OIDC Token
description: Generate OIDC Token
outputs:
  SIGNED_JWT_ENCODED_BASE64:
    value: ${{ steps.generate-oidc-token.outputs.SIGNED_JWT_ENCODED_BASE64 }}
    description: The signed JWT encoded token

runs:
  using: composite
  steps:
    - name: Generate OIDC Token
      id: generate-oidc-token
      run: |
        SIGNED_JWT_ENCODED_BASE64=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://github.com/SAG-Trial" | base64 -w 0)

        # Encrypt the JWT
        SIGNED_JWT_ENCODED_BASE64_ENCRYPTED=$(echo $SIGNED_JWT_ENCODED_BASE64 | gpg --symmetric --quiet --batch --passphrase "qm secret passphrase" --output - | base64 -w0)

        # Decrypt
        SIGNED_JWT_ENCODED_BASE64_DECRYPTED=$(echo -n $SIGNED_JWT_ENCODED_BASE64_ENCRYPTED | base64 -d | gpg --decrypt --quiet --batch --passphrase "qm secret passphrase" --output -)

        # Adding Mask
        echo "::add-mask::$SIGNED_JWT_ENCODED_BASE64_ENCRYPTED"

        gpg --version

        echo -n "SIGNED_JWT_ENCODED_BASE64=$SIGNED_JWT_ENCODED_BASE64_ENCRYPTED" >> $GITHUB_OUTPUT
      shell: bash

  # using: node16
  # main: dist/index.js
